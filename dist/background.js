let r=null;const a=e=>`events_${e}`,n=async e=>{if(!r)return;const t=a(r);if(!t)return;const{[t]:s=[]}=await browser.storage.local.get(t);s.push(e),await browser.storage.local.set({[t]:s})};async function d(){const e=`session_${Date.now()}`;return r=e,await browser.storage.local.set({activeSession:e,[a(e)]:[]}),e}const l=async()=>{console.log(`Session ended ${r}`),r=null,await browser.storage.local.remove("activeSession")};browser.tabs.onCreated.addListener(e=>{n({id:crypto.randomUUID(),type:"tab-created",tabId:e.id,openerTabId:e.openerTabId??null,url:e.url??null,timestamp:Date.now()})});browser.tabs.onUpdated.addListener((e,t)=>{t.url&&n({id:crypto.randomUUID(),type:"tab-updated",tabId:e,url:t.url,timestamp:Date.now()})});browser.tabs.onUpdated.addListener((e,t)=>{t.url&&n({id:crypto.randomUUID(),type:"tab-updated",tabId:e,url:t.url,timestamp:Date.now()})});browser.browserAction.onClicked.addListener(()=>{browser.tabs.create({url:browser.runtime.getURL("dist/viewer.html")})});const i=async()=>{const{activeSession:e}=await browser.storage.local.get("activeSession");return e??null};browser.runtime.onMessage.addListener(async(e,t)=>{switch(e.type){case"START_SESSION":return await d(e.sessionId),!0;case"END_SESSION":return await l(),!0;case"GET_ACTIVE_SESSION":return await i();case"GET_EVENTS":return r?i().then(async s=>{if(!s)return[];const o=a(s),{[o]:c=[]}=await browser.storage.local.get(o);return c}):[]}});
