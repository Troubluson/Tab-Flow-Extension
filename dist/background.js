let a=null;const c=e=>`events_${e}`,n=async e=>{if(!currentSession)return;const t=await r();if(!t)return;const{[t]:s=[]}=await browser.storage.local.get(t);s.push(e),await browser.storage.local.set({[t]:s})};async function d(){const e=`session_${Date.now()}`;return a=e,await browser.storage.local.set({activeSession:e,[sessionKey(e)]:[]}),e}const l=async()=>{console.log(`Session ended ${currentSession}`),currentSession=null,await browser.storage.local.remove("activeSession")};browser.tabs.onCreated.addListener(e=>{n({id:crypto.randomUUID(),type:"tab-created",tabId:e.id,openerTabId:e.openerTabId??null,url:e.url??null,timestamp:Date.now()})});browser.tabs.onUpdated.addListener((e,t)=>{t.url&&n({id:crypto.randomUUID(),type:"tab-updated",tabId:e,url:t.url,timestamp:Date.now()})});browser.tabs.onUpdated.addListener((e,t)=>{t.url&&n({id:crypto.randomUUID(),type:"tab-updated",tabId:e,url:t.url,timestamp:Date.now()})});browser.browserAction.onClicked.addListener(()=>{browser.tabs.create({url:browser.runtime.getURL("dist/viewer.html")})});const r=async()=>{const{activeSession:e}=await browser.storage.local.get("activeSession");return e??null};browser.runtime.onMessage.addListener((e,t)=>{switch(e.type){case"START_SESSION":return d(e.sessionId),!0;case"END_SESSION":return l(),!0;case"GET_ACTIVE_SESSION":return r();case"GET_EVENTS":return a?r().then(async s=>{if(!s)return[];const o=c(s),{[o]:i=[]}=await browser.storage.local.get(o);return i}):[]}});
